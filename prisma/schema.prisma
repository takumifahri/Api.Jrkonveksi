// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            Int      @id @default(autoincrement())
  unique_id     String   @unique @default(cuid())
  email         String   @unique
  password      String
  name          String
  roleId        Int
  phone         String?
  address       String?
  is_blocked    Boolean?

  is_verified   Boolean  @default(false)

  login_attempt Int      @default(0)
  token_version Int      @default(0)
  last_login    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deleteAt      DateTime?
  role          Role     @relation(fields: [roleId], references: [id])

  // <-- added opposite relation fields
  customerOrders        PemesananKonveksi[]   @relation("CustomerOrders")
  adminHandledOrders    PemesananKonveksi[]   @relation("AdminHandledOrders")
  customerPayments      Transaction[]         @relation("Customer_Payment")
  adminHandledPayments  Transaction[]         @relation("Admin_Handled_Payment")
  auditLogs            AuditLog[]            // actions performed by this user
  adminAuditLogs       AuditLog[]            @relation("AdminAudit") // actions this user performed as admin
  @@map("users")
  ResponseContact   ResponseContact[]
}


model OTP_Verification {
  id              Int      @id @default(autoincrement())
  email           String
  otp_token       String   // hashed OTP
  expires_at      DateTime
  
  // Registration data (stored temporarily until verified)
  hashed_password String
  name            String
  address         String?
  phone           String?
  
  used            Boolean  @default(false)
  attempts        Int      @default(0)
  createdAt       DateTime @default(now())
  deletedAt       DateTime?

  @@index([email])
  @@map("otp_verifications")
}

model Role {
    id                Int                  @id @default(autoincrement())
  name  String 
  description  String 
  
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  deletedAt         DateTime?
  
  // Relations
  users       User[]

}

enum StatusMaterial {
  UNAVAILABLE
  AVAILABLE
  PENDING
}

model Materials {
  id         Int      @id @default(autoincrement())
  unique_id  String   @unique
  status     StatusMaterial
  description String
  name       String   @db.VarChar(255)
  quantity   Int?     @default(0)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime?

  // <-- added opposite relation field
  pemesanan  PemesananKonveksi[]
}

enum UkuranBaju {
  EXTRA_SMALL
  SMALL
  MEDIUM
  REGULER
  LARGE
  EXTRA_LARGE
  DOUBLE_EXTRA_LARGE
  CUSTOM
}

enum StatusPemesanan {
  PENDING
  DITOLAK
  NEGOSIASI
  PEMBAYARAN
  PENGERJAAN
  DIBATALKAN
  SELESAI 
}

model PemesananKonveksi {
  id                Int      @id @default(autoincrement())
  unique_id         String   @unique @default(cuid())

  nama_pemesanan    String
  total_harga       BigInt?
  ukuran            UkuranBaju
  status            StatusPemesanan
  jumlah_barang     Int
  warna             String? 
  catatan           String?

  material_sendiri  Boolean?  @default(false)

  // Referensi foto
  referensi_custom  Boolean?  @default(false)
  file_referensi_custom String? 

  user_id           Int
  admin_id          Int?
  material_id       Int?
  model_baju_id     Int?

  waktu_terima      DateTime?
  waktu_tolak       DateTime?

  alasan_ditolak    String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?

  // Two separate relations to User: customer and admin
  model             ModelBaju?  @relation("ModelBaju", fields: [model_baju_id], references: [id])

  customer          User     @relation("CustomerOrders", fields: [user_id], references: [id])
  admin             User?    @relation("AdminHandledOrders", fields: [admin_id], references: [id])

  // material relation (many-to-one) -> Materials must have opposite array
  material          Materials? @relation(fields: [material_id], references: [id])

    // sisi nonâ€‘defining: tidak menyertakan fields+references
  transaction        Transaction? @relation("Pemesanan_Transaction")
}

enum StatusPembayaran {
  LUNAS
  BELUM_BAYAR
  DIBATALKAN
  DITOLAK
}

enum PaymentMethod {
  GOPAY
  OVO
  SEABANK
  BCA
  SHOPEEPAY
}

model Transaction {
  id                Int      @id @default(autoincrement())
  unique_id         String   @unique @default(cuid())

  status            StatusPembayaran
  total_harga       BigInt
  payment_method    PaymentMethod?
  file_screenshot   String?
  keterangan        String?
  alasan_ditolak    String?

  custom_order_id   Int?     @unique
  user_id           Int
  admin_id          Int?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?

  // defining side: fields+references + same relation name
  custom_order      PemesananKonveksi? @relation("Pemesanan_Transaction", fields: [custom_order_id], references: [id])
  customer          User     @relation("Customer_Payment", fields: [user_id], references: [id])
  admin             User?    @relation("Admin_Handled_Payment", fields: [admin_id], references: [id])
}

model ModelBaju{
  id                Int      @id @default(autoincrement())
  unique_id         String   @unique @default(cuid())

  nama              String   @db.VarChar(255)
  deskripsi         String?
  material          String
  gambar_ref        String?
  size              Json?
  harga_minimum     BigInt?  @default(0)
  harga_maximum     BigInt?  @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?

  model        PemesananKonveksi[]   @relation("ModelBaju")
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String   // 'CREATE_ORDER', 'UPDATE_PAYMENT', 'DELETE_MATERIAL'
  entity      String   // 'custom_order', 'transaction', 'material'
  entity_id   Int?
  user_id     Int?
  admin_id    Int?
  old_data    Json?    // Data sebelum perubahan
  new_data    Json?    // Data setelah perubahan
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())
  
  user        User?    @relation(fields: [user_id], references: [id])
  admin       User?    @relation("AdminAudit", fields: [admin_id], references: [id])
  
  @@map("audit_logs")
}

model ContactForm {
  id                Int                  @id @default(autoincrement())
  unique_id         String               @unique
  name  String 
  email             String   
  phone             String                  
  title             String               @db.VarChar(255)
  Message           String  

  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  deletedAt         DateTime? 

  // Relations
  response          ResponseContact[]

}

model ResponseContact {
  id                Int                  @id @default(autoincrement())
  unique_id         String               @unique
  contact_id        Int        
  responden_id       Int        
          
  name              String 
  email             String   
  phone             String                  
  title             String               @db.VarChar(255)
  Message           String  

  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  deletedAt         DateTime? 

  ContactForm       ContactForm          @relation(fields: [contact_id], references: [id])
  user              User                 @relation(fields: [responden_id], references: [id])
}